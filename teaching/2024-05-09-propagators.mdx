---
title: Waves and Propagation
author: Yuri R. Tonin
author_title: Physics Engineer
author_url: https://github.com/yurirt94
author_image_url: /img/me.jpg
tags: [waves, propagation, nearfield, fresnel]
description: description
image: /img/hunte.png
hide_table_of_contents: false
---

import Figure from '../src/components/figure';
import SEO from '../src/components/seo';
import Reminder from '../src/components/reminder';


*This post is a (hopefully quick) guide on the most important equations for computing free space propagation of a wavefront in the Fresnel regime, and how to do it properly.*

### Helmholtz equation and elementary waves

First, some background. Consider a monochromatic wave $\psi$ in vacuum. It is governed by Helmholtz equation:
$$
\nabla^2\psi + k^2 \psi = 0 
$$
where $k = 2 \pi / \lambda$ is the wavenumber. The solutions to this equation are called elementary waves, which can either be

 - plane waves:

$$
\psi(\mathbf{r}) = A \exp{(-j \mathbf{k} \cdot \mathbf{r})} = A \exp{[-j (k_x x + k_y y + k_z z)]}
$$

 - or spherical waves:
$$
\psi(\mathbf{r}) = \frac{A}{r} \exp{(-j k r)} 
$$
The names indicate that the wavefronts (i.e. the surfaces of constant phase) are either planes or spheres. The term before the exponential is referred to as the *amplitude* of the wave, whereas the imaginary argument of the exponent is named the *phase*. For a spherical wave, the amplitude is modulated by the distance from the source due to the $1/r$ term.  

The figure below illustrates the propagation of a spherical wave. Near the source, the wavefronts are spherical but can be approximated by paraboloids as it propagates from the origin. For large distances, one may approximate them by planes waves.

<a >
    <Figure 
      data={{
            src: '/img/sphericalevolve.png',
            alt: 'propagationplanes',
            type: 'image'
      }} 
    />
  <br/>
</a>

In the real world, though, there is no free lunch. We usually encounter waves that are way more complex than these elementary waves. Fortunately, we can make things easier using the **Angular Spectrum** of waves.

### Angular Spectrum Method (ASM)

An arbitrary wavefront $\psi(x_1,y_1)$ at plane $z=0$ can be decomposed into plane wave components using the Fourier transform (FT):

$$
\psi(x_1,y_1) =  \frac{1}{2 \pi} \iint \hat{\psi}(k_x,k_y) e^{[-j (k_x x_1 + k_y y_1)]} dk_x dk_y
$$
In other words, the wavefront is composed by a sum of plane waves with phase $\phi = k_x x_1 + k_y y_1$, each with amplitude $\hat{\psi}(k_x,k_y)$. Any wavefront can be decomposed in such fashion, which makes things easier.

Now, how can one obtain the wavefront at a different plane $(x_2,y_2,z)$ in space? Well, instead of working directly with $\psi(x_1,y_1)$, one can propagate each plane wave component separately and then sum the contribution of all these elementary waves at $z$. This is done using the free space propagator: 

$$
H(k_x,k_y)=\exp{(j z \sqrt{k^2 - k_x^2 - k_ y^2})}
$$

such that the resulting wave is

$$
\psi(x_2,y_2,z) = \frac{1}{2 \pi} \iint \underbrace{\hat{\psi}_1(k_x,k_y) \exp{(j z \sqrt{k^2 - k_x^2 - k_ y^2}})}_{\text{free space propagator multiplies each component}} e^{-j (k_x x_2 + k_y y_2)}dk_x dk_y
$$

This expression can be written in operator form as
$$
\psi(x_2,y_2,z) = \mathcal{F}^{-1}\{ \mathcal{F}\{\psi(x_1,y_1)\} H(k_x,k_y)  \}
$$
The above expression arises directly from the *Raleigh-Sommerfeld* diffraction solution (see reference [4] for a more detailed explanation). The only assumption here is that the distance between source and observation points be much greater than the wavelength $\lambda$. 

### Important approximations

We can apply approximations to get simpler forms of the propagator. For that, we make use of the **paraxial approximation**. It is common to hear that such approximation means the wave makes small angles with the optical axis. However, a wave may have plane wave components spreading in all directions. Hence, a more correct way of saying this is that the non-negligible plane wave components make a small angle with the optical axis [2]. A paraxial wave can also be thought as one that varies much more in the trasversal $x,y$ plane than in the longitudinal $z$ direction.

The **paraxial Helmholtz equation** governs paraxial waves, and it presents two important solutions:

- Paraboloidal wave 

This is also known as the **Fresnel diffraciton integral**. It is the paraxial approximation to the spherical wave:

$$
\psi(x_2,y_2) = \frac{e^{ikz}}{i \lambda z} \iint_{-\infty}^{+\infty} \psi(x_1,y_1) e^{ \frac{i k}{2 z}\left[{(x_2-x_1)^2+(y_2-y_1)^2} \right]} dx_1 dy_1
$$

In this case, 

#TODO: paraboloids of revolution?



 - Gaussian beam: 

#TODO: revise gaussian beam equations

 The Gaussian beam is a more complex, but extremely useful solution which appears in lasers, optical communication and many optical instruments. It is described by:

$$
\psi(x, y, z) = \psi_0 \frac{w_0}{w(z)} \exp\left(-\frac{x^2 + y^2}{w(z)^2}\right) \exp\left(-ikz - ik\frac{x^2 + y^2}{2R(z)} + i\zeta(z)\right)
$$

The $xy$ dependence of the wavefunction is Gaussian, given the waves its name. We can see the transversal slice at $z=0$ in the figure below, which shows exactly such Gaussian distribution. 

<a >
    <Figure 
      data={{
            src: '/img/gaussianbeam.png',
            alt: 'gaussianbeam',
            type: 'image'
      }} 
    />
    <figcaption align = "center"><b> Transversal and longitudional cuts to a Gaussian beam</b></figcaption>
  <br/>
</a>


As the equation shows, there are a few parameters to model the bahavior of a Gaussian beam. First, it is useful to define the Rayleigh length $z_R$

$$
z_R = \frac{\pi w_0^2}{\lambda}
$$
where $w_0$ is called the *beam waist*, which corresponds to the minimum radius of the beam, chosen to be at $z=0$. The Rayleigh length is used to write the other quantities of interest, namely:

- Beam radius:

$$
w(z) = w_0 \sqrt{1 + \left(\frac{z}{z_R}\right)^2}
$$

- Radius of curvature:

$$
R(z) = z \left[1 + \left(\frac{z_R}{z}\right)^2\right]
$$

- Gouy phase:

$$
\zeta(z) = \arctan\left(\frac{z}{z_R}\right)
$$


A few comments on these equation may help us understand the Gaussian beam. First, the transversal size of the beam is indeed minimum at $w(z=0) = w_0$. This size increases in both $\pm z$ directions


<a >
    <Figure 
      data={{
            src: 'https://upload.wikimedia.org/wikipedia/commons/5/53/GaussianBeamWaist.svg',
            alt: 'propagationplanes',
            type: 'image'
      }} 
    />
    <figcaption align = "center"><b> Gaussian beam parameters in the longitudinal plane.</b></figcaption>
  <br/>
</a>  




### Using the Fresnel diffraction integral

Let us rewrite the Fresnel diffraction integral (FDI): 

$$
\psi(x_2,y_2) = \frac{e^{ikz}}{i \lambda z} \iint_{-\infty}^{+\infty} \psi(x_1,y_1) e^{ \frac{i k}{2 z}\left[{(x_2-x_1)^2+(y_2-y_1)^2} \right]} dx_1 dy_1 \tag{1}
$$

We can expand the exponent inside the integral and move some terms out, arriving at the following form:

$$
\psi(x_2,y_2) = \frac{e^{ikz}}{i \lambda z} e^{ \frac{i k}{2 z}\left[{x_2^2+y_2^2} \right]} \iint_{-\infty}^{+\infty} \psi (x_1,y_1) e^{ \frac{i k}{2 z} \left[{x_1^2+y_1^2} \right] } e^{ \frac{i k}{2 z}{(x_2 x_1+y_2 y_1)} }dx_1 dy_1 \tag{2}
$$

 The two ways of computing it are named the **Convolution** and **Fourier Transform** forms of the Fresnel Diffraction integral. Although mathematically identical, they are numerically different. One must be careful to choose between them depending on the problem at hand.

#### Convolution methods

##### - Impulse Response method

A convolution between two functions f and g is defined by

$$
f \ast g = \int_{-\infty}^{+\infty} f(t) g(t-\tau) d\tau
$$

Equation (1) is nothing more than a convolution of $\psi$ with the following impulse responde function $h$

$$
    h(x,y) =  \frac{e^{ikz}}{i \lambda z} e^{ \frac{i k}{2 z}\left[{x^2+y^2} \right]} \tag{3}
$$

Making use of the [convolution theorem](https://en.wikipedia.org/wiki/Convolution_theorem), it can be calculated in Fourier space as 

##### - Transfer function method

$$
  \psi(x_2,y_2) = \mathcal{F}^{-1}\{ \mathcal{F}\{ \psi(x_1,y_1) \} H(f_{x_1},f_{y_1}) \} \tag{4}
$$
where
$$
    H(f_{x1},f_{y1}) = \mathcal{F}\{h(x_1,y_1)\} = e^{jkz} e^{j \pi \lambda z (f_{x}^2+f_{y}^2)} \tag{5}
$$

Note that computing equation (4), one should preferably pre-compute $H(f_{x_1},f_{y_1})$ in order to spare one calculation of the Fourier Transform. In this case, two FTs are left for calculation. In this case, the pixel size

#### Chirp functions

Equations (3) and (5) define what we call a *chirp function*. In each of the above methods, $\psi$ is modulated by a different chirp function. 

For the IR method it is sampled in real space:

$$
C_1 = e^{ \frac{i k}{2 z} \left({x_1^2+y_1^2} \right) } 
$$
whereas for the SFT it is samples in reciprocal space:
$$
C_2 = e^{j \pi \lambda z (f_{x}^2+f_{y}^2)}
$$
This is the reason why they are numerically different. Correctly evaluation of the Fast Fourier transform requires proper sampling according to the [Nyquist sampling theorem](https://en.wikipedia.org/wiki/Nyquist–Shannon_sampling_theorem) in order to avoid aliasing.

Furthermore, the discrete Fourier Transform imposes that 

$$
\Delta x = \frac{1}{N \Delta f}
$$
where $N$ is the number of points in your matrix. In other words, for a given N there is an inverse relationship between the sampling $\Delta x$ in real-space and the sampling $\Delta f$ in reciprocal space. This indicates that, the best one chirp function is sampled, the worst the other one will be. This is as strong indication that one method might be superior to the other depending on the situation. But how to choose?

### When to use which?

Now, to the practical side: how do you choose which to use? In that case one may use a rule of thumb (although for the details I'd recommend taking a close look at the references below):

| Criteria&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| Sampling&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Comment |
| -------------------------------- | -------------------------------- | ------  |
| $\Delta x > \frac{\lambda z}{z}$ | TF: oversampled.&nbsp;&nbsp;&nbsp;&nbsp; IR: undersampled | IR method causes periodic copies. TF is the method of choice. Observation plane width will be limited to width $D + \lambda z / \Delta x$|
| $\Delta x = \frac{\lambda z}{z}$ | both TF and IR: critical sampling | TF and IR are identical |
| $\Delta x < \frac{\lambda z}{z}$ | TF: undersampled. IR: oversampled | It depends. Needs to evaluate if source bandwidth satisfies $B \le \frac{z}{2 \lambda z}$. If yes, use TF. Otherwise, IR may be better. |


#### Fourier Transform methods

##### - Single Fourier Transform

Equation (2) on the other hand can be seen as a Fourier Transform:

$$
    \psi(x_2,y_2) = \frac{e^{ikz}}{i \lambda z} e^{ \frac{i k}{2 z}\left[{x_2^2+y_2^2} \right]} \mathcal{F}\{ \psi(x_1,y_1) e^{ \frac{i k}{2 z} \left[{x_1^2+y_1^2} \right] } \}
$$
Notice still, that it can be rewritten using $h(x,y)$, such that
$$
    \psi(x_2,y_2) =  e^{ \frac{i k}{2 z}\left[{x_2^2+y_2^2} \right]} \mathcal{F}\{ \psi(x_1,y_1) h(x_1,y_1) \} \} \tag{6}
$$
In contrast to equation (4), the above expression requires a single Fourier Transform computation.

##### Grid spacing

We are interested here in computing propagation on a computer, using discrete matrices. An important difference between the SFT method and the convolution methods is that the latter always involve an inverse Fourier transform at the end, whereas the first does not. This has consequences on the final grid spacing of the resulting matrix. 

$$
p_2 = \frac{\lambda z}{N p_1}
$$

##### - Fresnel propagator in 2 steps

One alternative to select the pixel size $p_2$ in the output plane is to perform the propagation in two steps. The idea is to first propagate the wavefront from $z_1$ to an intermediary plane $z_i$, and then from $z_i$ to the final desired plane $z_2$. We introduce a scaling parameter $m$ such that

$$
p_2 = m p_1
$$
It turns out that this scaling paremeter relates to the positions in the $z$ axis as
$$
m = |\frac{z_2 - z_i}{z_i - z_1}| = |\frac{\Delta z_2}{\Delta z_1}|
$$

In that case, the wavefront $\psi$ is obtained via

$$
\begin{align*}
\psi(x_2,y_2,z_2)  & = \frac{z_2}{z_1} e^{j 2 \pi z/\lambda} \exp{\left[ -j \frac{\pi}{\lambda z} \frac{z_1-z_2}{z_2} (x_2^2+y_2^2)  \right]} 
\\ & \mathcal{F}^{-1}\{\exp{[-j\pi \lambda z \frac{z_1}{z_2}(f_{x1}^2+f_{y_1}^2)]}  \mathcal{F}\{ \psi_1(x_1,y_1,z_1) \exp{[j \frac{\pi}{\lambda z}\frac{z_1-z_2}{z_1}(x_1^2+y_1^2)]}\} \}
\end{align*}
$$

However, the above expression presents a serious issue. It requires computing both chirp function in real and reciprocal space simultaneously. Therefore, unless working with critical sampling, the expression above will always be partly wrong due to undersampling of one of the two expressions. 


### Fresnel scaling theorem

One particularly common scenario is that of divergent or cone-beam sources. These are the cases where the beam divergence is quite large for the lengths of interest, such that the expansion of the beam becomes relevant. The Fresnel diffraction integral is of course still valid. Nonetheless, if we are dealing with large propagation distances and a large divergence, a beam with only microns in size may expand hundreds of times in dimension. If you need to compute this numerically in a computer, it may be necessary to work with matrix with dozens of thousands of pixels, making you calculation infeasible due to computer memory limitations.

Fortunately, there exists a clever workaround in this case, called the *Fresnel Scaling Theorem* (FST). Essentially, the FST states that a divergent spherical wave has an equivalent plane-wave equivalent with scaled pixels and distances. 

In the cone-beam case, the focus to sample distance $z_1$ and the sample to output plane distance $z_2$ can be used to define the *magnification $M$* of the system:

$$
M = \frac{z_1 + z_2}{z_1}
$$

This quantity is used then to convert from the cone to the equivalent parallel beam geometry. Note that we recover the parallel case ($M=1$) when $z_1 \rightarrow + \infty$.

<a >
    <Figure 
      data={{
            src: '/img/fst_geometries.jpeg',
            alt: 'fstgeometries',
            type: 'image'
      }} 
    />
    <figcaption align = "center"><b> Original geometry (left) and the two types of equivalent geometries (#1, center. #2, right). </b></figcaption>
  <br/>
</a>


#### Equivalent geometry #1

The most well know geometry puts the reference on the pixel size $d$ of the input plane. In this case, the distance between input and output planes and the output pixel size are downscaled according to

$$
z_2 \rightarrow z_2/M
$$
and
$$
D \rightarrow D/M
$$

#### Equivalent geometry #2

A less well-known equivalent geometry [6] puts instead the reference on te pixel size $D$ of the output plane. In that case, an upscaling happens:

$$
z_2 \rightarrow M z_2
$$
and
$$
D \rightarrow M D
$$

#### Validity of the FST

I would like to emphasize here that the Fresnel Scaling theorem assumes a point source, i.e., spherical waves. Therefore, to apply the FST the waves reaching our object in the input plane must be spherical. In many practical situations that may not be the case. 

Referring back to the Gaussian beam equations, the phase is not yet spherical within the Rayleigh length. A minimum distance $2z_0$ from the beam waist is required for application of the FST, since only then the phase wavefront can be approximatted by a spherical wavefront again [7].

### References

  - [1] Saleh, B. E. A., & Teich, M. C. (1991). Fundamentals of Photonics. Wiley. https://doi.org/10.1002/0471213748
  - [2] Paganin, David, Coherent X-Ray Optics, Oxford Series on Synchrotron Radiation (2006), https://doi.org/10.1093/acprof:oso/9780198567288.001.0001
  - [3] Goodman, J. W., & Cox, M. E. (1969). Introduction to Fourier Optics. 
  - [4] Voelz, D. G. (2011). Computational Fourier Optics: A MATLAB Tutorial. SPIE. https://doi.org/10.1117/3.858456
  - [5] Schmidt, J. D. (2010). Numerical Simulation of Optical Wave Propagation with Examples in MATLAB. SPIE. https://doi.org/10.1117/3.866274
  - [6] Hu Ziyang, et. al. (2023) “Near-Field Multi-Slice Ptychography: Quantitative Phase Imaging of Optically Thick Samples with Visible Light and X-Rays.”. https://doi.org/10.1364/OE.487002.
  - [7]  Robisch, Anna-Lena. “Phase Retrieval for Object and Probe in the Optical Near-Field.” Universitätsverlag Göttingen, 2016.


### Appendix: Raleigh-Sommerfeld Diffraction

$$
\psi_2(x_2,y_2) = \frac{z}{j \lambda} \iint_S \psi_1(x_1,y_1) \frac{\exp{(j k r_{12})}}{r_{12}^2} dx_1 dy_1
$$
where
$$
r_{12} = \sqrt{z^2 + (x_2 - x_1)^2 + (y_2 - y_1)^2}
$$

<a >
    <Figure 
      data={{
            src: 'https://upload.wikimedia.org/wikipedia/commons/a/a2/Diffraction_geometry.svg',
            alt: 'propagationplanes',
            type: 'image'
      }} 
    />
    <figcaption align = "center"><b> Source plane located at $0$ and target plane at position $z$.</b></figcaption>
  <br/>
</a>

<!--truncate-->

<SEO
  uri='blog/name'
  image='img/template.jpg'
  type='article'
/>



